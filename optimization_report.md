# t5.py è®­ç»ƒé—®é¢˜ä¿®å¤æŠ¥å‘Š

## ğŸ¯ ä¿®å¤çš„æ ¸å¿ƒé—®é¢˜

### é—®é¢˜ 1: æ·±åº¦å‘½ä¸­ç‡ 0% âŒ â†’ âœ…

**ç—‡çŠ¶**: `Depth Hit Rate: 0.00%` å§‹ç»ˆä¸º 0

**æ ¹æœ¬åŸå› **: Camera ID ä¸åŒ¹é…
- **GaussianAdapter** ä½¿ç”¨ `uid` æˆ– `colmap_id` (æ•´æ•°)
- **NeuSAdapter** ä½¿ç”¨ `image_name stem` (å­—ç¬¦ä¸²ï¼Œå¦‚ "IMG_1234")
- ä¸¤è€…å®Œå…¨ä¸åŒ¹é…ï¼Œå¯¼è‡´ç¼“å­˜æŸ¥æ‰¾å¤±è´¥

**ä¿®å¤æ–¹æ¡ˆ**:
```python
# gaussian_adapter.py - ä¿®æ”¹å
camera_name = getattr(cam, "image_name", None)
from pathlib import Path
primary_key = Path(camera_name).stem if camera_name else camera_id

payload = {
    "camera_id": primary_key,  # ä½¿ç”¨ image stem ä½œä¸ºä¸»é”®
    "image_name": camera_name,
    "uid": camera_id,  # ä¿ç•™åŸå§‹ ID ä¾›å‚è€ƒ
}
```

**é¢„æœŸæ•ˆæœ**: æ·±åº¦å‘½ä¸­ç‡åº”æå‡åˆ° **80-95%**

---

### é—®é¢˜ 2: é«˜æ–¯æ•°é‡çˆ†ç‚¸ âŒ â†’ âœ…

**ç—‡çŠ¶**: 
```
æ­¥éª¤ 100: 309,686 (+255,411)
æ­¥éª¤ 400: 1,527,910 (+1,473,635)
Densify/Prune: +1473635 / -0  â† å®Œå…¨æ²¡æœ‰ prune!
```

**æ ¹æœ¬åŸå› **: 
1. **æ¯æ­¥éƒ½åœ¨ densify** - æ²¡æœ‰é¢‘ç‡æ§åˆ¶
2. **è¿‡æ—©å¼€å§‹** - ä»ç¬¬ 1 æ­¥å°±å¼€å§‹ï¼Œæ¢¯åº¦è¿˜æœªç´¯ç§¯
3. **è¿‡åº¦æ¿€è¿›** - `omega_g=1.0` å¤ªå¤§ï¼Œå‡ ä¹æ‰€æœ‰ç‚¹éƒ½è¢« densify
4. **å‡ ä¹ä¸ prune** - `min_opacity=0.005` å¤ªå°

**ä¿®å¤æ–¹æ¡ˆ 1**: æ·»åŠ è¿­ä»£çª—å£å’Œé¢‘ç‡æ§åˆ¶
```python
# fusion_wrapper.py
# åªåœ¨ 500-15000 æ­¥ä¹‹é—´åº”ç”¨
if iteration < 500 or iteration >= opt.densify_until_iter:
    return

# æ¯ 100 æ­¥æ‰æ‰§è¡Œä¸€æ¬¡ï¼ˆåŒ¹é…æ ‡å‡† 3DGSï¼‰
if iteration % 100 != 0:
    return
```

**ä¿®å¤æ–¹æ¡ˆ 2**: æ£€æŸ¥æ¢¯åº¦ç´¯ç§¯
```python
# å¿…é¡»æœ‰æœ‰æ•ˆçš„æ¢¯åº¦ç´¯ç§¯æ‰æ‰§è¡Œ
if grad_accum is None or denom is None or denom.sum() == 0:
    return
```

**ä¿®å¤æ–¹æ¡ˆ 3**: å‡å°‘ densify æƒé‡
```python
# ä» 1.0 é™ä½åˆ° 0.3
omega_g = self.sdf_guidance_cfg.get("omega_g", 0.3)  

# åªåœ¨é è¿‘è¡¨é¢çš„ç‚¹å¢å¼ºæ¢¯åº¦
eps_g = grads + omega_g * mu_expanded * (mu > 0.5).float().unsqueeze(-1)
```

**ä¿®å¤æ–¹æ¡ˆ 4**: å¢å¼º prune
```python
# æé«˜æœ€å°ä¸é€æ˜åº¦é˜ˆå€¼ä» 0.005 â†’ 0.01
min_opacity = 0.01
```

**é¢„æœŸæ•ˆæœ**: 
- é«˜æ–¯æ•°é‡å¢é•¿ **å¯æ§**
- é¢„è®¡åœ¨ 30K æ­¥æ—¶è¾¾åˆ° **200K-400K** (è€Œé 1.5M+)
- Densify/Prune æ¯”ä¾‹åˆç†ï¼Œä¾‹å¦‚ `+150K / -80K`

---

### é—®é¢˜ 3: æ›´æ–°é»˜è®¤å‚æ•° âŒ â†’ âœ…

**åŸå‚æ•°** (å¤ªæ¿€è¿›):
```python
omega_g = 1.0    # æƒé‡å¤ªå¤§
tau_g = 0.0002   # é˜ˆå€¼å¤ªå°
tau_p = 0.005    # prune å¤ªå¼±
```

**æ–°å‚æ•°** (æ›´ä¿å®ˆ):
```python
omega_g = 0.3    # é™ä½ 70%
tau_g = 0.0005   # æé«˜ 2.5å€
tau_p = 0.01     # æé«˜ 2å€
```

---

## ğŸ“Š é¢„æœŸè®­ç»ƒæ•ˆæœ

### ä¿®å¤å‰ vs ä¿®å¤å

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| æ·±åº¦å‘½ä¸­ç‡ | 0% | 80-95% |
| é«˜æ–¯æ•°é‡ (æ­¥éª¤ 400) | 1.5M | ~100K |
| Densify é¢‘ç‡ | æ¯æ­¥ | æ¯ 100 æ­¥ |
| Prune æ•°é‡ | 0 | æ˜¾è‘—æå‡ |
| GPU æ˜¾å­˜ | å‰§çƒˆæ³¢åŠ¨ | ç¨³å®š |
| NeuS Loss æ³¢åŠ¨ | 1.3~2.8 | åº”å¹³æ»‘æ”¶æ•› |

### è®­ç»ƒæ—¥å¿—åº”è¯¥çœ‹åˆ°çš„å˜åŒ–

**ä¿®å¤åçš„æ­£å¸¸è¾“å‡º** (æ¯ 100 æ­¥):
```
=== Fusion Statistics (iter 500) ===
Depth Cache: 193 entries
Depth Hit Rate: 87.23%  â† å¤§å¹…æå‡ï¼
Num Gaussians: 98,234   â† æ§åˆ¶åœ¨åˆç†èŒƒå›´
Densify/Prune: +45,123 / -16,432  â† æœ‰å®é™…çš„ prune
NeuS Iter: 500
```

---

## ğŸš€ é‡æ–°è®­ç»ƒæŒ‡å—

### ç«‹å³æµ‹è¯•

```bash
# ä½¿ç”¨ä¿®å¤åçš„ä»£ç é‡æ–°è®­ç»ƒ
python t5.py --scene_name bicycle --joint_iterations 30000
```

### æ‰‹åŠ¨å¾®è°ƒï¼ˆå¦‚æœéœ€è¦ï¼‰

å¦‚æœæ·±åº¦å‘½ä¸­ç‡ä» < 50%:
```bash
python t5.py --scene_name bicycle --dg_max_age 100
```

å¦‚æœé«˜æ–¯æ•°é‡ä»ç„¶è¿‡å¤š:
```bash
python t5.py --scene_name bicycle --sdf_omega_g 0.1 --sdf_tau_p 0.02
```

å¦‚æœé«˜æ–¯æ•°é‡å¤ªå°‘:
```bash
python t5.py --scene_name bicycle --sdf_omega_g 0.5
```

---

## ğŸ” ç›‘æ§è¦ç‚¹

### å…³é”®æŒ‡æ ‡

1. **æ·±åº¦å‘½ä¸­ç‡**: åº”è¯¥åœ¨ **80-95%**
   - å¦‚æœ < 50%ï¼Œè¯´æ˜ camera ID åŒ¹é…ä»æœ‰é—®é¢˜

2. **é«˜æ–¯æ•°é‡å¢é•¿**: åº”è¯¥ **å¹³æ»‘ä¸”å¯æ§**
   - æ­¥éª¤ 500: ~80K-120K
   - æ­¥éª¤ 15000: ~200K-400K
   - ä¹‹åç¨³å®šæˆ–ç•¥æœ‰ä¸‹é™

3. **Densify/Prune æ¯”ä¾‹**: åº”è¯¥ **éƒ½æœ‰æ•°å€¼**
   - ä¾‹å¦‚: `+120K / -40K`
   - Prune ä¸åº”è¯¥æ˜¯ 0

4. **Loss æ”¶æ•›**: åº”è¯¥ **å¹³æ»‘ä¸‹é™**
   - GS loss: 0.3 â†’ 0.1 (é€æ­¥ä¸‹é™)
   - NeuS loss: 1.5 â†’ 0.5 (é€æ­¥ä¸‹é™)

---

## ğŸ“ ä¿®æ”¹æ‘˜è¦

### ä¿®æ”¹çš„æ–‡ä»¶

1. **`fusion/gaussian_adapter.py`**
   - ä¿®æ”¹ camera ID ä½¿ç”¨ image_name stem

2. **`fusion/fusion_wrapper.py`**
   - æ·»åŠ è¿­ä»£çª—å£æ£€æŸ¥ (500-15000)
   - æ·»åŠ é¢‘ç‡æ§åˆ¶ (æ¯ 100 æ­¥)
   - æ·»åŠ æ¢¯åº¦ç´¯ç§¯æ£€æŸ¥
   - å‡å°‘ omega_g é»˜è®¤å€¼
   - æ·»åŠ è¡¨é¢é‚»è¿‘è¿‡æ»¤
   - å¢åŠ  min_opacity é˜ˆå€¼

3. **`t5.py`**
   - æ›´æ–°é»˜è®¤å‚æ•°ï¼š
     - `omega_g`: 1.0 â†’ 0.3
     - `tau_g`: 0.0002 â†’ 0.0005
     - `tau_p`: 0.005 â†’ 0.01

---

## âœ… ä¸‹ä¸€æ­¥

1. **é‡æ–°è¿è¡Œè®­ç»ƒ**
   ```bash
   python t5.py --scene_name bicycle --joint_iterations 30000
   ```

2. **è§‚å¯Ÿå‰ 500 æ­¥**
   - æ·±åº¦å‘½ä¸­ç‡åº”è¯¥å¿«é€Ÿä¸Šå‡åˆ° 80%+
   - é«˜æ–¯æ•°é‡å¢é•¿åº”è¯¥å˜æ…¢

3. **å¦‚æœé—®é¢˜ä¾ç„¶å­˜åœ¨**
   - æ£€æŸ¥ camera ID æ‰“å°ï¼ˆå¯èƒ½éœ€è¦é¢å¤–è°ƒè¯•ï¼‰
   - è¿›ä¸€æ­¥è°ƒæ•´ omega_g å’Œ tau å‚æ•°

---

## ğŸ¯ æ€»ç»“

ä¸‰ä¸ªæ ¸å¿ƒä¿®å¤ï¼š

1. âœ… **Camera ID åŒ¹é…** - ç»Ÿä¸€ä½¿ç”¨ image_name stem
2. âœ… **Densify é¢‘ç‡æ§åˆ¶** - 500-15000 æ­¥ï¼Œæ¯ 100 æ­¥æ‰§è¡Œ
3. âœ… **å‚æ•°ä¼˜åŒ–** - æ›´ä¿å®ˆçš„é»˜è®¤å€¼

**é¢„æœŸç»“æœ**: ç¨³å®šã€å¯æ§çš„è®­ç»ƒè¿‡ç¨‹ï¼Œæ·±åº¦å¼•å¯¼æœ‰æ•ˆå·¥ä½œï¼Œé«˜æ–¯æ•°é‡åˆç†å¢é•¿ã€‚
